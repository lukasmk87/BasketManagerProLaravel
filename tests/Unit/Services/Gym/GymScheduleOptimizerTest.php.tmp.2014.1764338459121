<?php

namespace Tests\Unit\Services\Gym;

use App\Models\GymHall;
use App\Models\GymTimeSlot;
use App\Models\Team;
use App\Models\User;
use App\Services\Gym\GymConflictDetector;
use App\Services\Gym\GymScheduleOptimizer;
use Carbon\Carbon;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class GymScheduleOptimizerTest extends TestCase
{
    use RefreshDatabase;

    private GymScheduleOptimizer $optimizer;

    protected function setUp(): void
    {
        parent::setUp();
        $conflictDetector = new GymConflictDetector();
        $this->optimizer = new GymScheduleOptimizer($conflictDetector);
    }

    public function test_creates_time_slot(): void
    {
        $gymHall = GymHall::factory()->create();

        $data = [
            'title' => 'Training U16',
            'day_of_week' => 'monday',
            'start_time' => '14:00',
            'end_time' => '16:00',
            'slot_type' => 'training',
            'status' => 'active',
        ];

        $timeSlot = $this->optimizer->createTimeSlot($gymHall, $data);

        $this->assertInstanceOf(GymTimeSlot::class, $timeSlot);
        $this->assertEquals('Training U16', $timeSlot->title);
        $this->assertEquals($gymHall->id, $timeSlot->gym_hall_id);
    }

    public function test_assigns_time_slot_to_team(): void
    {
        $gymHall = GymHall::factory()->create();
        $team = Team::factory()->create();
        $user = User::factory()->create();

        $timeSlot = GymTimeSlot::factory()->create([
            'gym_hall_id' => $gymHall->id,
        ]);

        $result = $this->optimizer->assignTimeSlotToTeam($timeSlot, $team, $user, 'Test assignment');

        $this->assertTrue($result);
        $timeSlot->refresh();
        $this->assertEquals($team->id, $timeSlot->team_id);
    }

    public function test_generates_bookings_for_recurring_slot(): void
    {
        $gymHall = GymHall::factory()->create();
        $team = Team::factory()->create();

        $timeSlot = GymTimeSlot::factory()->create([
            'gym_hall_id' => $gymHall->id,
            'team_id' => $team->id,
            'is_recurring' => true,
            'day_of_week' => 'monday',
        ]);

        $startDate = Carbon::now()->startOfWeek();
        $endDate = $startDate->copy()->addMonth();

        $count = $this->optimizer->generateBookingsForTimeSlot($timeSlot, $startDate, $endDate);

        $this->assertGreaterThan(0, $count);
    }

    public function test_does_not_generate_bookings_for_non_recurring_slot(): void
    {
        $gymHall = GymHall::factory()->create();
        $team = Team::factory()->create();

        $timeSlot = GymTimeSlot::factory()->create([
            'gym_hall_id' => $gymHall->id,
            'team_id' => $team->id,
            'is_recurring' => false,
        ]);

        $startDate = Carbon::now();
        $endDate = $startDate->copy()->addMonth();

        $count = $this->optimizer->generateBookingsForTimeSlot($timeSlot, $startDate, $endDate);

        $this->assertEquals(0, $count);
    }

    public function test_finds_available_slots(): void
    {
        $gymHall = GymHall::factory()->create([
            'supports_parallel_bookings' => true,
            'operating_hours' => [
                'monday' => [
                    'is_open' => true,
                    'open_time' => '08:00',
                    'close_time' => '22:00',
                ],
            ],
        ]);

        $date = Carbon::now()->next('Monday');

        $availableSlots = $this->optimizer->findAvailableSlots($gymHall, $date, 30, 1);

        $this->assertIsArray($availableSlots);
    }

    public function test_returns_empty_for_closed_day(): void
    {
        $gymHall = GymHall::factory()->create([
            'operating_hours' => [
                'sunday' => [
                    'is_open' => false,
                ],
            ],
        ]);

        $date = Carbon::now()->next('Sunday');

        $availableSlots = $this->optimizer->findAvailableSlots($gymHall, $date, 30, 1);

        $this->assertEmpty($availableSlots);
    }

    public function test_gets_court_schedule(): void
    {
        $gymHall = GymHall::factory()->create([
            'operating_hours' => [
                'monday' => [
                    'is_open' => true,
                    'open_time' => '08:00',
                    'close_time' => '22:00',
                ],
            ],
        ]);

        $startDate = Carbon::now()->startOfWeek();
        $endDate = $startDate->copy()->addDays(2);

        $schedule = $this->optimizer->getCourtSchedule($gymHall, $startDate, $endDate);

        $this->assertIsArray($schedule);
        $this->assertCount(3, $schedule); // 3 days
    }

    public function test_generates_daily_time_grid(): void
    {
        $gymHall = GymHall::factory()->create([
            'operating_hours' => [
                'monday' => [
                    'is_open' => true,
                    'open_time' => '08:00',
                    'close_time' => '12:00',
                ],
            ],
        ]);

        $date = Carbon::now()->next('Monday');

        $grid = $this->optimizer->generateDailyTimeGrid($gymHall, $date, 30);

        $this->assertIsArray($grid);
    }
}
